#:import Factory kivy.factory.Factory

<ImageCard>:
    orientation: 'vertical'
    size_hint_y: None
    height: "300dp"
    padding: "5dp"
    spacing: "5dp"
    
    # Card Background with Shadow-like effect
    canvas.before:
        Color:
            rgba: (0.2, 0.2, 0.2, 1) if not self.selected else (0.3, 0.4, 0.6, 1)
        RoundedRectangle:
            pos: self.pos
            size: self.size
            radius: [10,]

    # --- TOP: Image Area (Click to View) ---
    RelativeLayout:
        size_hint_y: 0.85
        
        # The Image Itself
        AsyncImage:
            source: root.thumbnail
            allow_stretch: True
            keep_ratio: True
            nocache: False
            fit_mode: "contain"
            pos_hint: {'center_x': 0.5, 'center_y': 0.5}

        # Invisible Button covering ONLY the image area for viewing
        Button:
            background_color: 0, 0, 0, 0
            size_hint: 1, 1
            pos_hint: {'center_x': 0.5, 'center_y': 0.5}
            on_release: root.on_image_click()

        # Selection Checkbox (Top Right, clearly visible)
        CheckBox:
            size_hint: None, None
            size: "48dp", "48dp"
            pos_hint: {'top': 1, 'right': 1}
            active: root.selected
            on_active: root.on_checkbox_active(self, self.active)
            canvas.before:
                Color:
                    rgba: 0, 0, 0, 0.5 # tiny dimmed background for checkbox visibility
                Ellipse:
                    pos: self.pos
                    size: self.size

    # --- BOTTOM: Info Area ---
    BoxLayout:
        size_hint_y: 0.15
        orientation: 'vertical'
        padding: "2dp"
        
        Label:
            text: root.source
            font_size: "12sp"
            color: 0.7, 0.7, 0.7, 1
            text_size: self.size
            halign: 'left'
            valign: 'middle'

<RootWidget>:
    orientation: 'vertical'
    canvas.before:
        Color:
            rgba: 0.1, 0.1, 0.1, 1
        Rectangle:
            pos: self.pos
            size: self.size

    # Header
    BoxLayout:
        size_hint_y: None
        height: "60dp"
        padding: "10dp"
        spacing: "10dp"
        canvas.before:
            Color:
                rgba: 0.15, 0.15, 0.15, 1
            Rectangle:
                pos: self.pos
                size: self.size
        
        TextInput:
            id: search_input
            hint_text: "Search..."
            multiline: False
            size_hint_x: 0.6
            background_color: 0.2, 0.2, 0.2, 1
            foreground_color: 1, 1, 1, 1
            on_text_validate: root.do_search()
            
        Button:
            text: "GO"
            size_hint_x: 0.2
            background_color: 0.2, 0.6, 1, 1
            bold: True
            on_release: root.do_search()

    # Filters
    BoxLayout:
        size_hint_y: None
        height: "50dp"
        padding: "5dp"
        spacing: "5dp"
        
        Spinner:
            id: engine_spinner
            text: 'Rule34'
            values: ('Rule34', 'Bing', 'DuckDuckGo')
            background_color: 0.25, 0.25, 0.25, 1
            
        Spinner:
            id: size_spinner
            text: 'Any Size'
            values: ('Any Size', 'Wallpaper', '4k')
            background_color: 0.25, 0.25, 0.25, 1

    # Grid
    RecycleView:
        id: rv
        viewclass: 'ImageCard'
        scroll_type: ['bars', 'content']
        bar_width: "10dp"
        
        RecycleGridLayout:
            default_size: None, dp(300)
            default_size_hint: 1, None
            size_hint_y: None
            height: self.minimum_height
            cols: 2 # 2 columns usually best for phone
            spacing: "10dp"
            padding: "10dp"

    # Footer Actions
    BoxLayout:
        size_hint_y: None
        height: "60dp"
        padding: "5dp"
        spacing: "10dp"
        canvas.before:
            Color:
                rgba: 0.15, 0.15, 0.15, 1
            Rectangle:
                pos: self.pos
                size: self.size

        Button:
            id: load_more_btn
            text: "Load More"
            disabled: True
            on_release: root.load_more()
            background_color: 0.3, 0.3, 0.3, 1

        Button:
            id: download_btn
            text: "Download (0)"
            disabled: True
            background_color: 0.2, 0.8, 0.2, 1
            on_release: root.download_selected()
