#:import Factory kivy.factory.Factory

<ImageCard>:
    orientation: 'vertical'
    size_hint_y: None
    height: "280dp"
    padding: "4dp"
    spacing: "2dp"
    
    canvas.before:
        Color:
            rgba: (0.2, 0.2, 0.2, 1) if not self.selected else (0.2, 0.5, 0.8, 1)
        RoundedRectangle:
            pos: self.pos
            size: self.size
            radius: [8,]

    RelativeLayout:
        size_hint_y: 0.85
        
        AsyncImage:
            source: root.thumbnail
            allow_stretch: True
            keep_ratio: True
            nocache: False
            fit_mode: "contain"
            pos_hint: {'center_x': 0.5, 'center_y': 0.5}

        # Main Click -> Open Viewer
        Button:
            background_color: 0, 0, 0, 0
            size_hint: 1, 1
            on_release: root.on_image_click()

        # Checkbox -> Selection
        CheckBox:
            size_hint: None, None
            size: "40dp", "40dp"
            pos_hint: {'top': 1, 'right': 1}
            active: root.selected
            on_active: root.on_checkbox_active(self, self.active)
            canvas.before:
                Color: 
                    rgba: 0, 0, 0, 0.4
                Ellipse:
                    pos: self.pos
                    size: self.size

    Label:
        text: root.source
        size_hint_y: 0.15
        font_size: "11sp"
        color: 0.8, 0.8, 0.8, 1
        text_size: self.size
        halign: 'left'
        valign: 'middle'
        shorten: True
        shorten_from: 'right'

<RootWidget>:
    orientation: 'vertical'
    canvas.before:
        Color:
            rgba: 0.1, 0.1, 0.1, 1
        Rectangle:
            pos: self.pos
            size: self.size

    # Header
    BoxLayout:
        size_hint_y: None
        height: "60dp"
        padding: "10dp"
        spacing: "10dp"
        canvas.before:
            Color:
                rgba: 0.15, 0.15, 0.15, 1
            Rectangle:
                pos: self.pos
                size: self.size
        
        TextInput:
            id: search_input
            hint_text: "Search..."
            multiline: False
            size_hint_x: 0.6
            background_color: 0.2, 0.2, 0.2, 1
            foreground_color: 1, 1, 1, 1
            on_text_validate: root.do_search()
            
        Button:
            text: "GO"
            size_hint_x: 0.2
            background_color: 0.2, 0.6, 1, 1
            bold: True
            on_release: root.do_search()

    # Filters
    BoxLayout:
        size_hint_y: None
        height: "50dp"
        padding: "5dp"
        spacing: "5dp"
        
        Spinner:
            id: engine_spinner
            text: 'Rule34'
            values: ('Rule34', 'Bing', 'DuckDuckGo')
            background_color: 0.25, 0.25, 0.25, 1
            
        Spinner:
            id: size_spinner
            text: 'Any Size'
            values: ('Any Size', 'Wallpaper', '4k')
            background_color: 0.25, 0.25, 0.25, 1

    # Grid
    RecycleView:
        id: rv
        viewclass: 'ImageCard'
        scroll_type: ['bars', 'content']
        bar_width: "10dp"
        
        RecycleGridLayout:
            default_size: None, dp(280)
            default_size_hint: 1, None
            size_hint_y: None
            height: self.minimum_height
            cols: 2 # 2 columns usually best for phone
            spacing: "6dp"
            padding: "6dp"

    # Footer Actions
    BoxLayout:
        size_hint_y: None
        height: "60dp"
        padding: "5dp"
        spacing: "10dp"
        canvas.before:
            Color:
                rgba: 0.15, 0.15, 0.15, 1
            Rectangle:
                pos: self.pos
                size: self.size

        Button:
            id: load_more_btn
            text: "Load More"
            disabled: True
            on_release: root.load_more()
            background_color: 0.3, 0.3, 0.3, 1

        Button:
            id: download_btn
            text: "Download (0)"
            disabled: True
            background_color: 0.2, 0.8, 0.2, 1
            on_release: root.download_selected()
